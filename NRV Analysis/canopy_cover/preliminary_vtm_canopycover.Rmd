---
title: "Canopy Cover_VTM"
author: "Hannah Garcia-Wickstrum"
date: "11/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Upload packages
library(tidyverse)
library(tidyr)
```

```{r}
# read in data
vtm_data <- read.table(here::here("vtm_data", "vtm_dataset_750m_buffer_FINAL.txt"))
```

### Canopy Cover Overview
## Equations

# 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
# 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
# 4.4.1.4: CW = HT * s1 (HT <4.5' and DBH<DBHT)
# 4.4.1.5: CW = d1 + d2 * DBH (HT>4.5' and DBH<DBHT)

# CW is maximum tree crown width
# DBH is tree diameter at breast height
# DBH(subT) is threshold diameter 

## Table (from...) Coefficients and equation reference for crown width equations {4.4.2.1}-{4.4.2.5} in the WS variant

# Sugar Pine (PILA), Equation 4.4.2.1, DBH(subT) = 7.4 / SP
# White fir (ABCO), Equation 4.4.2.1, DBH(subT) = 5 / WF
# Incense cedar (CADE), Equation 4.4.2.1, DBH(subT) = 5 / IC
# Jeffrey Pine (PIJE), Equation 4.4.2.2, DBH(subT) = 5 / JP
# Ponderosa Pine (PIPO), Equation 4.4.2.2, DBH(subT) = 5 / PP
# Coulter Pine (PICO), Equation 4.4.2.2, DBH(subT) = 5 / CP
# Bigcone Spruce (PSMA), Equation 4.4.2.1, DBH (subT) = 5 / BD
# Canyon Live Oak (QUCH), Equation 4.4.2.1, DBH(subT) = 5 / CY
# Black Oak (QUKE), Equation 4.4.2.1, DBH(subT) = 5 / BO

```{r}
## Constants for equations 
# --------------------------------------------------
# Sugar Pine (PILA) constants:
pila_d1 <- 3.5
pila_d2 <- 0.338
pila_a1 <- -1.476
pila_a2 <- 1.01
pila_s1 <- 0.7778

# White fir (ABCO) constants:
abco_d1 <- 3.26
abco_d2 <- 1.103
abco_a1 <- 5.82
abco_a2 <- 0.591
abco_s1 <- 0.7778

# Incense Cedar (CADE) constants:
cade_d1 <- 3.5
cade_d2 <- 1.192
cade_a1 <- 7.11
cade_a2 <- 0.47
cade_s1 <- 0.7778

# Jeffrey Pine (PIJE) constants: 
pije_d1 <- 3.5
pije_d2 <- 0.5754
pije_a1 <- 1.52
pije_a2 <- 0.891
pije_s1 <- 0.7778

# Ponderosa Pine (PIPO) constants:
pipo_d1 <- 3.77
pipo_d2 <- 0.7756
pipo_a1 <- 2.24
pipo_a2 <- 0.763
pipo_s1 <- 0.7778

# Coulter Pine (PICO) constants:
pico_d1 <- 3.5
pico_d2 <- 1.7618
pico_a1 <- 3.9347
pico_a2 <- 0.7086
pico_s1 <- 0.7778

# Bigcone Spruce (PSMA) constants
psma_d1 <- 3.5
psma_d2 <- 5.5672
psma_a1 <- 27.030
psma_a2 <- 0.8612
psma_s1 <- 0.7778

# Canyon Live Oak (QUCH) constants:
quch_d1 <- 2.5
quch_d2 <- 2.19
quch_a1 <- 5
quch_a2 <- 1.69
quch_s1 <- 0.5556

# Black Oak (QUKE) constants:
quke_d1 <- 2.5
quke_d2 <- 2.7
quke_a1 <- 10
quke_a2 <- 1.2
quke_s1 <- 0.5556

pi <- 3.1415926535 # Leana added this constant
e <- 2.718281828 # Leana added this constant
```


```{r}
## Anne-Marie's midpoints for 36+ dbh
# vtm_basal_largest <- vtm_tidy %>% 
#   filter(dbh_class == "dbh_36") %>% 
#   mutate(dbh_final = case_when(
#     species == "ABCO" ~ 106 + 14,-->47.2
#     species == "CADE" ~ 162,-->63.8
#     species == "PICO" ~ 99 + 5,-->40.9
#     #species == "PIJE" ~ 104 + 12,-->45.7
#     species == "PILA" ~ 108 + 15,-->48.4
#     #species == "PIPO" ~ 110 + 18,-->50.4
#     species == "Yellow Pine" ~ 104 + 13,-->46.1
#     species == "PSMA" ~ 107 + 13,-->47.2
#     species == "QUCH" ~ 98 - 6,-->36.2
#     species == "QUKE" ~ 93-->36.6

# final dbh 36+ class (rounded to the nearest tenth)
# Yellow pine = 46.1 inches
# ABCO = 47.2 inches
# CADE = 63.8 inches 
# PICO = 40.9 inches
# PILA = 48.4 inches
# PSMA = 47.2 inches
# QUCH = 36.2 inches
# QUKE = 36.6 inches
```

```{r}
# How to go about canopy cover calculation
# From Hugh NRV: "First, we used species-specific equations for crown-width (above) to estimate crown area, using the midpoint of thee size class in our calculations, then multiplying by the number of trees in that size class. Percentage of cover was obtained by summing across the size classes and standardizing to square meters, then dividing the result by 10,000 (number of square meters in a hectare) and multiplying by 100 for percentage. 
# From Keyser 2010: "Crown width for each tree is reported in the tree list ouput table and used for percent canopy cover (PCC) calculations. Crown width is calculated by using equations [4.4.2.1] - [4.4.2.5]. If a tree has a DBH greater than or equal to its threshold diameter (given as DBH(subT), then it uses equations [4.4.2.1], [4.4.2.2], or [4.4.2.3] depending on the species. If a tree has a DBH less than its threshold diameter, then it uses equation [4.4.2.4] or [4.4.2.5], depending on the height of the tree. )
```


# PIPO Canopy Cover 
```{r}
# Use Equation 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
# DBH(subT) is 5 and our lowest dbh is 7.5 since we are taking the midpoint of each class. 

# Select only PIPO & select only needed columns
# Pivot_longer to get size classes as observations
# get rid of zeros (goes from 328 observations to 198). When uncount, goes from 198 to 865.

vtm_pipo <- vtm_data %>%
  filter(abbreviation == "PIPO") %>%
  select(plotkey, abbreviation, n,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent)%>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "46.1")) # used Anne-Marie's measurements. Used the yellow pine value for pipo and pije, but we should double check this!


# change dbh_class & canopy_cover to numeric
vtm_pipo$dbh_class <- as.numeric(vtm_pipo$dbh_class)
# str(vtm_pipo)
vtm_pipo <- mutate(vtm_pipo, canopy_width = (pipo_a1 * (dbh_class^(pipo_a2)))) # Leana renamed canopy_cover to canopy_width because this is what the equation is calculating
vtm_pipo$canopy_width <- as.numeric(vtm_pipo$canopy_width)
# note: canopy_width is in feet (https://sourceforge.net/p/open-fvs/wiki/FVS_API/?version=2)

# Questions: 
# 1. What do we want to do with the midpoint for 36+ class? (hgw) I forgot, did we discuss this with Bruce/Anne-Marie at the meeting? I'm guessing it would be hard to find literature on the largest recorded dbh per species from the 1930s...perhaps we could use the largest dbh per species from the FIA data and use that as the bound? I know it's not the best, but it is some measure of how big each species can get. 

## ------------------------------------------------------------------------------------------------
# Leana added this section. It is best to calculate canopy area here, and not after grouping the data, because canopy area should be calculated based off of the canopy_width and not the sum of all canopy_widths. Ex. The canopy area of a tree with a canopy width of 10 is roughly 78.5. Let's say we have 5 trees in this size class, then the total canopy area of all five trees would be (78.5 * 5), which is roughly 396. This is not equivalent to adding the canopy widths (10*5), and then finding the area based off of this width. The area of a tree with crown width of 50 is roughly 1963. I hope that makes sense!

# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_pipo_canopy <- vtm_pipo %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) # Hannah, this was correct. I just deleted the part where you converted to feet, because I believe crown width is already in feet (this is what we discussed with Bruce). 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pipo_sum <- vtm_pipo_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) # checked a couple of plots against the vtm_pipo dataframe and they added up to the correct amount.  
```

# PIJE Canopy Cover 
```{r}
# Equation for PIJE: # 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
vtm_pije <- vtm_data %>%
  filter(abbreviation == "PIJE") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "46.1"))

vtm_pije$dbh_class <- as.numeric(vtm_pije$dbh_class)
vtm_pije <- mutate(vtm_pije, canopy_width = (pije_a1 * (dbh_class^(pije_a2))))
vtm_pije$canopy_width <- as.numeric(vtm_pije$canopy_width)

## ------------------------------------------------------------------------------------------------
# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_pije_canopy <- vtm_pije %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pije_sum <- vtm_pije_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# PILA Canopy Cover
```{r}
# Use Equation: # 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
vtm_pila <- vtm_data %>%
  filter(abbreviation == "PILA") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "48.4"))

vtm_pila$dbh_class <- as.numeric(vtm_pila$dbh_class)
vtm_pila <- mutate(vtm_pila, canopy_width = (pila_a1 + pila_a2 * (dbh_class)))
vtm_pila$canopy_width <- as.numeric(vtm_pila$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_pila_canopy <- vtm_pila %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pila_sum <- vtm_pila_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# PICO Canopy Cover
```{r}
# Use Equation 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
vtm_pico <- vtm_data %>%
  filter(abbreviation == "PICO3") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "40.9"))

vtm_pico$dbh_class <- as.numeric(vtm_pico$dbh_class)
vtm_pico <- mutate(vtm_pico, canopy_width = (pico_a1 * (dbh_class^(pico_a2))))
vtm_pico$canopy_width <- as.numeric(vtm_pico$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_pico_canopy <- vtm_pico %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pico_sum <- vtm_pico_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# ABCO Canopy Cover
```{r}
# # White fir (ABCO), Equation 4.4.2.1, DBH(subT) = 5
# # 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_abco <- vtm_data %>%
  filter(abbreviation == "ABCO") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "47.2"))

vtm_abco$dbh_class <- as.numeric(vtm_abco$dbh_class)
vtm_abco <- mutate(vtm_abco, canopy_width = (abco_a1 + abco_a2 * (dbh_class)))
vtm_abco$canopy_width <- as.numeric(vtm_abco$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_abco_canopy <- vtm_abco %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_abco_sum <- vtm_abco_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# CADE Canopy Cover
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_cade <- vtm_data %>%
  filter(abbreviation == "CADE") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "63.8"))

vtm_cade$dbh_class <- as.numeric(vtm_cade$dbh_class)
vtm_cade <- mutate(vtm_cade, canopy_width = (cade_a1 + cade_a2 * (dbh_class)))
vtm_cade$canopy_width <- as.numeric(vtm_cade$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_cade_canopy <- vtm_cade %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_cade_sum <- vtm_cade_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# PSMA canopy cover
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
vtm_psma <- vtm_data %>%
  filter(abbreviation == "PSMA") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "47.2"))

vtm_psma$dbh_class <- as.numeric(vtm_psma$dbh_class)
vtm_psma <- mutate(vtm_psma, canopy_width = (psma_a1 + psma_a2 * (dbh_class)))
vtm_psma$canopy_width <- as.numeric(vtm_psma$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_psma_canopy <- vtm_psma %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_psma_sum <- vtm_psma_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# QUCH Canopy Cover
```{r}
# Use Equation  4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_quch <- vtm_data %>%
  filter(abbreviation == "QUCH") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36.2"))

vtm_quch$dbh_class <- as.numeric(vtm_quch$dbh_class)
vtm_quch <- mutate(vtm_quch, canopy_width = (quch_a1 + quch_a2 * (dbh_class)))
vtm_quch$canopy_width <- as.numeric(vtm_quch$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_quch_canopy <- vtm_quch %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_quch_sum <- vtm_quch_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# QUKE Canopy Cover
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_quke <- vtm_data %>%
  filter(abbreviation == "QUKE") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count")%>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36.6"))

vtm_quke$dbh_class <- as.numeric(vtm_quke$dbh_class)
vtm_quke <- mutate(vtm_quke, canopy_width = (quke_a1 + quke_a2 * (dbh_class)))
vtm_quke$canopy_width <- as.numeric(vtm_quke$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_quke_canopy <- vtm_quke %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_quke_sum <- vtm_quke_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# Combine all dataframes to calculate relative canopy cover
```{r}
# combine all species dataframes back together so we can sum the species in plots
vtm_total_canopy <- do.call("rbind", list(vtm_abco_sum,
                                          vtm_cade_sum,
                                          vtm_pico_sum,
                                          vtm_pije_sum,
                                          vtm_pila_sum,
                                          vtm_pipo_sum,
                                          vtm_psma_sum,
                                          vtm_quch_sum,
                                          vtm_quke_sum)) 

# n = the area (ft^2) covered by the canopies of all the trees in that size class/species/plot
## ------------------------------------------------------------------------------------------------

# Next we can sum the total canopy cover of all trees from all size classes PER PLOT
vtm_total_canopy_plot <- vtm_total_canopy %>% 
  group_by(plotkey, national_forest_name) %>% 
  tally(n) %>% 
  rename("total_canopy_area" = "n" )
# this checks out! There are 195 unique vtm plots! Leana checked a few plots and it looks good!
## ------------------------------------------------------------------------------------------------

# right now the total_canopy_area column is in ft^2, we want to convert this to m^2. 
# 1 ft^2 = 0.092903 m^2

# create a column that converts squared feet to squared meters
vtm_total_canopy_plot <- vtm_total_canopy_plot %>% 
  mutate(total_canopy_area_meters = (total_canopy_area *0.092903))

# Divide the total canopy area per plot (measured in m^2) by the size of the plot (also measured in m^2). Note: A vtm plot is 809 m^2. Then multiply by 100 to obtain a percent canopy cover. 
# Hannah: an FIA plot is 672.45 m^2.
vtm_total_canopy_plot <- vtm_total_canopy_plot %>% 
  mutate(percent_canopy_cover = ((total_canopy_area_meters/809) * 100))
# note that some of the percent covers are above 100%, because we have not yet accounted for overlapping canopies. 
# we have now determined the percent canopy cover without accounting for overlap--> equivalent to equation 1 in Crookston and Stage 1999 (https://www.fs.fed.us/rm/pubs/rmrs_gtr024.pdf).
```

# Now apply equation 2 from Crookston and Stage 1999 to account for overlapping canopies. 
```{r}
# Equation 2 (page 2 of https://www.fs.fed.us/rm/pubs/rmrs_gtr024.pdf):
# C = 100 [1 – exp ( – .01 C′ )]
# C = percent canopy cover that accounts for overlap,
# C′ = equation 1-percent canopy cover without accounting for overlap. *This has been calculated in the section above. 
# exp = e^

vtm_total_canopy_plot <- vtm_total_canopy_plot %>% 
  mutate(percent_canopy_cover_nonoverlap = (100*(1-(e^(-.01*percent_canopy_cover)))))
# I THINK it's okay to do this step here (after I've summed the canopy cover per plot), but I can go back and check if applying this equation earlier on changes our results. 
```

# Summarize findings
```{r}
# with canopy overlap
# average percent canopy cover across all YPMC plots when allowing for canopy overlap
mean(vtm_total_canopy_plot$percent_canopy_cover)
# 100.6753

canopy_cover_overlap <- vtm_total_canopy_plot %>% 
  mutate (national_forest_name = "All Plots") %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover),
    sd = sd(percent_canopy_cover),
    sample_size = n(),
    se = sd(percent_canopy_cover)/sqrt(n()),
    var = var(percent_canopy_cover))

canopy_cover_overlap_forests <- vtm_total_canopy_plot %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover),
    sd = sd(percent_canopy_cover),
    sample_size = n(),
    se = sd(percent_canopy_cover)/sqrt(n()),
    var = var(percent_canopy_cover))

canopy_cover_overlap_summary <- do.call("rbind", list(canopy_cover_overlap,
                                          canopy_cover_overlap_forests))

## -----------------------------------------------------------------------------------------------
# without canopy overlap
# average percent canopy cover across all YPMC plots when removing for canopy overlap
mean(vtm_total_canopy_plot$percent_canopy_cover_nonoverlap)
# 54.9521

canopy_cover_nonoverlap <- vtm_total_canopy_plot %>% 
  mutate (national_forest_name = "All Plots") %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

canopy_cover_nonoverlap_forests <- vtm_total_canopy_plot %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

canopy_cover_nonoverlap_summary <- do.call("rbind", list(canopy_cover_nonoverlap,
                                          canopy_cover_nonoverlap_forests))
```

# Make graphs
```{r}
# create final dataframe for graph
canopy_cover_nonoverlap_summary_rm_NA <-canopy_cover_nonoverlap_summary %>% 
  mutate(color = case_when(national_forest_name == "All Plots" ~ "1",
                           national_forest_name == "anf" ~ "0",
                           national_forest_name == "cnf" ~ "0",
                           national_forest_name == "lpnf" ~ "0",
                           national_forest_name == "sbnf" ~ "0",
                           national_forest_name == "N/A" ~ "0",
                           TRUE ~ "none"))
canopy_cover_nonoverlap_summary_rm_NA$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA$national_forest_name == "anf"] <-"ANF"
canopy_cover_nonoverlap_summary_rm_NA$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA$national_forest_name == "cnf"] <-"CNF"
canopy_cover_nonoverlap_summary_rm_NA$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA$national_forest_name == "lpnf"] <-"LPNF"
canopy_cover_nonoverlap_summary_rm_NA$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA$national_forest_name == "sbnf"] <-"SBNF"
canopy_cover_nonoverlap_summary_rm_NA$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA$national_forest_name == "N/A"] <-"Other"
canopy_cover_nonoverlap_summary_rm_NA$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA$national_forest_name == "All Plots"] <-"All YPMC"

# make factors
x_factor <- c("ANF", "CNF", "LPNF", "SBNF","Other", "All YPMC")
color_factor <- c("0", "1")

 ggplot(canopy_cover_nonoverlap_summary_rm_NA,aes(x=factor(national_forest_name, x_factor),y=mean, fill=factor(color, color_factor)))+
   scale_fill_manual(values = c("#636161", "#A00D35"))+
  geom_col(stat="identity",position=position_dodge(width = 0.4), width = 0.4)+
  geom_point(data = canopy_cover_nonoverlap_summary_rm_NA, aes(x=national_forest_name, y= mean),position=position_dodge(width = 0.4), color = "black", size = 1.3, shape = 16)+
geom_errorbar(data = canopy_cover_nonoverlap_summary_rm_NA,
              position=position_dodge(width = 0.4),
                aes(x = national_forest_name, 
                    ymin = mean - se,
                    ymax = mean + se),
                color = "black",
                width = 0.08) +
  theme_bw()+
  labs(title = "Average Percent Canopy Cover of YPMC", x = "Location", y = "Percent Canopy Cover") +
  theme(plot.title = element_text(hjust= 0.5,
                                  face = "bold",
                                  margin=margin(0,0,10,0))) +
  theme(axis.title.x = element_text (face = "bold",
                                     margin=margin(10,0,0,0))) +
  theme(axis.title.y = element_text (face = "bold",
                                     margin=margin(0,10,0,0)))+
  scale_y_continuous( expand = c(0,0))+
  expand_limits(y = c(0, 70))+
  theme(axis.text.x = element_text(color = "black", size = 9))+
  theme(legend.position = "none")
```

# VTM canopy cover using 36 as the 36+ size class midpoint WITH oaks

# PIPO Canopy Cover (2)
```{r}
# Use Equation 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
# DBH(subT) is 5 and our lowest dbh is 7.5 since we are taking the midpoint of each class. 

# Select only PIPO & select only needed columns
# Pivot_longer to get size classes as observations
# get rid of zeros (goes from 328 observations to 198). When uncount, goes from 198 to 865.

vtm_pipo_2 <- vtm_data %>%
  filter(abbreviation == "PIPO") %>%
  select(plotkey, abbreviation, n,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent)%>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36")) # used Anne-Marie's measurements. Used the yellow pine value for pipo and pije, but we should double check this!


# change dbh_class & canopy_cover to numeric
vtm_pipo_2$dbh_class <- as.numeric(vtm_pipo_2$dbh_class)
# str(vtm_pipo)
vtm_pipo_2 <- mutate(vtm_pipo_2, canopy_width = (pipo_a1 * (dbh_class^(pipo_a2)))) # Leana renamed canopy_cover to canopy_width because this is what the equation is calculating
vtm_pipo_2$canopy_width <- as.numeric(vtm_pipo_2$canopy_width)
# note: canopy_width is in feet (https://sourceforge.net/p/open-fvs/wiki/FVS_API/?version=2)

# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_pipo_canopy_2 <- vtm_pipo_2 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2))
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pipo_sum_2 <- vtm_pipo_canopy_2 %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) # checked a couple of plots against the vtm_pipo dataframe and they added up to the correct amount.  
```

# PIJE Canopy Cover (2)
```{r}
# Equation for PIJE: # 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
vtm_pije_2 <- vtm_data %>%
  filter(abbreviation == "PIJE") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_pije_2$dbh_class <- as.numeric(vtm_pije_2$dbh_class)
vtm_pije_2 <- mutate(vtm_pije_2, canopy_width = (pije_a1 * (dbh_class^(pije_a2))))
vtm_pije_2$canopy_width <- as.numeric(vtm_pije_2$canopy_width)

## ------------------------------------------------------------------------------------------------
# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_pije_canopy_2 <- vtm_pije_2 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pije_sum_2 <- vtm_pije_canopy_2 %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# PILA Canopy Cover (2)
```{r}
# Use Equation: # 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
vtm_pila_2 <- vtm_data %>%
  filter(abbreviation == "PILA") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_pila_2$dbh_class <- as.numeric(vtm_pila_2$dbh_class)
vtm_pila_2 <- mutate(vtm_pila_2, canopy_width = (pila_a1 + pila_a2 * (dbh_class)))
vtm_pila_2$canopy_width <- as.numeric(vtm_pila_2$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_pila_canopy_2 <- vtm_pila_2 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pila_sum_2 <- vtm_pila_canopy_2 %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# PICO Canopy Cover (2)
```{r}
# Use Equation 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
vtm_pico_2 <- vtm_data %>%
  filter(abbreviation == "PICO3") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_pico_2$dbh_class <- as.numeric(vtm_pico_2$dbh_class)
vtm_pico_2 <- mutate(vtm_pico_2, canopy_width = (pico_a1 * (dbh_class^(pico_a2))))
vtm_pico_2$canopy_width <- as.numeric(vtm_pico_2$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_pico_canopy_2 <- vtm_pico_2 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pico_sum_2 <- vtm_pico_canopy_2 %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# ABCO Canopy Cover (2)
```{r}
# # White fir (ABCO), Equation 4.4.2.1, DBH(subT) = 5
# # 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_abco_2 <- vtm_data %>%
  filter(abbreviation == "ABCO") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_abco_2$dbh_class <- as.numeric(vtm_abco_2$dbh_class)
vtm_abco_2 <- mutate(vtm_abco_2, canopy_width = (abco_a1 + abco_a2 * (dbh_class)))
vtm_abco_2$canopy_width <- as.numeric(vtm_abco_2$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_abco_canopy_2 <- vtm_abco_2 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_abco_sum_2 <- vtm_abco_canopy_2 %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# CADE Canopy Cover (2)
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_cade_2 <- vtm_data %>%
  filter(abbreviation == "CADE") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_cade_2$dbh_class <- as.numeric(vtm_cade_2$dbh_class)
vtm_cade_2 <- mutate(vtm_cade_2, canopy_width = (cade_a1 + cade_a2 * (dbh_class)))
vtm_cade_2$canopy_width <- as.numeric(vtm_cade_2$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_cade_canopy_2 <- vtm_cade_2 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_cade_sum_2 <- vtm_cade_canopy_2 %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# PSMA canopy cover (2)
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
vtm_psma_2 <- vtm_data %>%
  filter(abbreviation == "PSMA") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_psma_2$dbh_class <- as.numeric(vtm_psma_2$dbh_class)
vtm_psma_2 <- mutate(vtm_psma_2, canopy_width = (psma_a1 + psma_a2 * (dbh_class)))
vtm_psma_2$canopy_width <- as.numeric(vtm_psma_2$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_psma_canopy_2 <- vtm_psma_2 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_psma_sum_2 <- vtm_psma_canopy_2 %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# QUCH Canopy Cover (2)
```{r}
# Use Equation  4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_quch_2 <- vtm_data %>%
  filter(abbreviation == "QUCH") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_quch_2$dbh_class <- as.numeric(vtm_quch_2$dbh_class)
vtm_quch_2 <- mutate(vtm_quch_2, canopy_width = (quch_a1 + quch_a2 * (dbh_class)))
vtm_quch_2$canopy_width <- as.numeric(vtm_quch_2$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_quch_canopy_2 <- vtm_quch_2 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_quch_sum_2 <- vtm_quch_canopy_2 %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# QUKE Canopy Cover (2)
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_quke_2 <- vtm_data %>%
  filter(abbreviation == "QUKE") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count")%>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_quke_2$dbh_class <- as.numeric(vtm_quke_2$dbh_class)
vtm_quke_2 <- mutate(vtm_quke_2, canopy_width = (quke_a1 + quke_a2 * (dbh_class)))
vtm_quke_2$canopy_width <- as.numeric(vtm_quke_2$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_quke_canopy_2 <- vtm_quke_2 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_quke_sum_2 <- vtm_quke_canopy_2 %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

# Combine all dataframes to calculate relative canopy cover (2)
```{r}
# combine all species dataframes back together so we can sum the species in plots
vtm_total_canopy_2 <- do.call("rbind", list(vtm_abco_sum_2,
                                          vtm_cade_sum_2,
                                          vtm_pico_sum_2,
                                          vtm_pije_sum_2,
                                          vtm_pila_sum_2,
                                          vtm_pipo_sum_2,
                                          vtm_psma_sum_2,
                                          vtm_quch_sum_2,
                                          vtm_quke_sum_2)) 

# n = the area (ft^2) covered by the canopies of all the trees in that size class/species/plot
## ------------------------------------------------------------------------------------------------

# Next we can sum the total canopy cover of all trees from all size classes PER PLOT
vtm_total_canopy_plot_2 <- vtm_total_canopy_2 %>% 
  group_by(plotkey, national_forest_name) %>% 
  tally(n) %>% 
  rename("total_canopy_area" = "n" )
# this checks out! There are 195 unique vtm plots! Leana checked a few plots and it looks good!
## ------------------------------------------------------------------------------------------------

# right now the total_canopy_area column is in ft^2, we want to convert this to m^2. 
# 1 ft^2 = 0.092903 m^2

# create a column that converts squared feet to squared meters
vtm_total_canopy_plot_2 <- vtm_total_canopy_plot_2 %>% 
  mutate(total_canopy_area_meters = (total_canopy_area *0.092903))

# Divide the total canopy area per plot (measured in m^2) by the size of the plot (also measured in m^2). Note: A vtm plot is 809 m^2. Then multiply by 100 to obtain a percent canopy cover. 
# Hannah: an FIA plot is 672.45 m^2.
vtm_total_canopy_plot_2 <- vtm_total_canopy_plot_2 %>% 
  mutate(percent_canopy_cover = ((total_canopy_area_meters/809) * 100))
# note that some of the percent covers are above 100%, because we have not yet accounted for overlapping canopies. 
# we have now determined the percent canopy cover without accounting for overlap--> equivalent to equation 1 in Crookston and Stage 1999 (https://www.fs.fed.us/rm/pubs/rmrs_gtr024.pdf).
```

# Now apply equation 2 from Crookston and Stage 1999 to account for overlapping canopies. 
```{r}
# Equation 2 (page 2 of https://www.fs.fed.us/rm/pubs/rmrs_gtr024.pdf):
# C = 100 [1 – exp ( – .01 C′ )]
# C = percent canopy cover that accounts for overlap,
# C′ = equation 1-percent canopy cover without accounting for overlap. *This has been calculated in the section above. 
# exp = e^

vtm_total_canopy_plot_2 <- vtm_total_canopy_plot_2 %>% 
  mutate(percent_canopy_cover_nonoverlap = (100*(1-(e^(-.01*percent_canopy_cover)))))
# I THINK it's okay to do this step here (after I've summed the canopy cover per plot), but I can go back and check if applying this equation earlier on changes our results. 
```

# Summarize findings
```{r}
# with canopy overlap
# average percent canopy cover across all YPMC plots when allowing for canopy overlap
mean(vtm_total_canopy_plot_2$percent_canopy_cover) # 88.81102
#  100.6753 -- this was the mean when we used the mean + 1SD for the 36+ size class. So it did go down a bit

canopy_cover_overlap_2<- vtm_total_canopy_plot_2 %>% 
  mutate (national_forest_name = "All Plots") %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover),
    sd = sd(percent_canopy_cover),
    sample_size = n(),
    se = sd(percent_canopy_cover)/sqrt(n()),
    var = var(percent_canopy_cover))

canopy_cover_overlap_forests_2 <- vtm_total_canopy_plot_2 %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover),
    sd = sd(percent_canopy_cover),
    sample_size = n(),
    se = sd(percent_canopy_cover)/sqrt(n()),
    var = var(percent_canopy_cover))

canopy_cover_overlap_summary_2 <- do.call("rbind", list(canopy_cover_overlap_2,
                                          canopy_cover_overlap_forests_2))

## -----------------------------------------------------------------------------------------------
# without canopy overlap
# average percent canopy cover across all YPMC plots when removing for canopy overlap
mean(vtm_total_canopy_plot_2$percent_canopy_cover_nonoverlap) # 51.08581 not much different then before
# old mean = 54.9521

canopy_cover_nonoverlap_2 <- vtm_total_canopy_plot_2 %>% 
  mutate (national_forest_name = "All Plots") %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

canopy_cover_nonoverlap_forests_2 <- vtm_total_canopy_plot_2 %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

canopy_cover_nonoverlap_summary_2 <- do.call("rbind", list(canopy_cover_nonoverlap_2,
                                          canopy_cover_nonoverlap_forests_2))
```

# Make graphs
```{r}
# create final dataframe for graph
canopy_cover_nonoverlap_summary_rm_NA_2 <-canopy_cover_nonoverlap_summary_2 %>% 
  mutate(color = case_when(national_forest_name == "All Plots" ~ "1",
                           national_forest_name == "anf" ~ "0",
                           national_forest_name == "cnf" ~ "0",
                           national_forest_name == "lpnf" ~ "0",
                           national_forest_name == "sbnf" ~ "0",
                           national_forest_name == "N/A" ~ "0",
                           TRUE ~ "none"))
canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name == "anf"] <-"ANF"
canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name == "cnf"] <-"CNF"
canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name == "lpnf"] <-"LPNF"
canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name == "sbnf"] <-"SBNF"
canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name == "N/A"] <-"Other"
canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_2$national_forest_name == "All Plots"] <-"All YPMC"

# make factors
x_factor <- c("ANF", "CNF", "LPNF", "SBNF","Other", "All YPMC")
color_factor <- c("0", "1")

 ggplot(canopy_cover_nonoverlap_summary_rm_NA_2,aes(x=factor(national_forest_name, x_factor),y=mean, fill=factor(color, color_factor)))+
   scale_fill_manual(values = c("#636161", "#A00D35"))+
  geom_col(stat="identity",position=position_dodge(width = 0.4), width = 0.4)+
  geom_point(data = canopy_cover_nonoverlap_summary_rm_NA_2, aes(x=national_forest_name, y= mean),position=position_dodge(width = 0.4), color = "black", size = 1.3, shape = 16)+
geom_errorbar(data = canopy_cover_nonoverlap_summary_rm_NA_2,
              position=position_dodge(width = 0.4),
                aes(x = national_forest_name, 
                    ymin = mean - se,
                    ymax = mean + se),
                color = "black",
                width = 0.08) +
  theme_bw()+
  labs(title = "Average Percent Canopy Cover of YPMC", x = "Location", y = "Percent Canopy Cover") +
  theme(plot.title = element_text(hjust= 0.5,
                                  face = "bold",
                                  margin=margin(0,0,10,0))) +
  theme(axis.title.x = element_text (face = "bold",
                                     margin=margin(10,0,0,0))) +
  theme(axis.title.y = element_text (face = "bold",
                                     margin=margin(0,10,0,0)))+
  scale_y_continuous( expand = c(0,0))+
  expand_limits(y = c(0, 70))+
  theme(axis.text.x = element_text(color = "black", size = 9))+
  theme(legend.position = "none")
```

# VTM Canopy Cover with 36 as the midpoint for 36+ size class WITHOUT oaks
# Combine all dataframes to calculate relative canopy cover (3)
```{r}
# combine all species dataframes back together so we can sum the species in plots
vtm_total_canopy_3 <- do.call("rbind", list(vtm_abco_sum_2,
                                          vtm_cade_sum_2,
                                          vtm_pico_sum_2,
                                          vtm_pije_sum_2,
                                          vtm_pila_sum_2,
                                          vtm_pipo_sum_2,
                                          vtm_psma_sum_2)) # removed the oak species, which now has 884 observations. (with oaks had 1,042 observations)

# n = the area (ft^2) covered by the canopies of all the trees in that size class/species/plot
## ------------------------------------------------------------------------------------------------

# Next we can sum the total canopy cover of all trees from all size classes PER PLOT
vtm_total_canopy_plot_3 <- vtm_total_canopy_3 %>% 
  group_by(plotkey, national_forest_name) %>% 
  tally(n) %>% 
  rename("total_canopy_area" = "n" )
# this checks out! There are 195 unique vtm plots! Leana checked a few plots and it looks good!
## ------------------------------------------------------------------------------------------------

# right now the total_canopy_area column is in ft^2, we want to convert this to m^2. 
# 1 ft^2 = 0.092903 m^2

# create a column that converts squared feet to squared meters
vtm_total_canopy_plot_3 <- vtm_total_canopy_plot_3 %>% 
  mutate(total_canopy_area_meters = (total_canopy_area *0.092903))

# Divide the total canopy area per plot (measured in m^2) by the size of the plot (also measured in m^2). Note: A vtm plot is 809 m^2. Then multiply by 100 to obtain a percent canopy cover. 
# Hannah: an FIA plot is 672.45 m^2.
vtm_total_canopy_plot_3 <- vtm_total_canopy_plot_3 %>% 
  mutate(percent_canopy_cover = ((total_canopy_area_meters/809) * 100))
# note that some of the percent covers are above 100%, because we have not yet accounted for overlapping canopies. 
# we have now determined the percent canopy cover without accounting for overlap--> equivalent to equation 1 in Crookston and Stage 1999 (https://www.fs.fed.us/rm/pubs/rmrs_gtr024.pdf).
```

# Now apply equation 2 from Crookston and Stage 1999 to account for overlapping canopies. (3)
```{r}
# Equation 2 (page 2 of https://www.fs.fed.us/rm/pubs/rmrs_gtr024.pdf):
# C = 100 [1 – exp ( – .01 C′ )]
# C = percent canopy cover that accounts for overlap,
# C′ = equation 1-percent canopy cover without accounting for overlap. *This has been calculated in the section above. 
# exp = e^

vtm_total_canopy_plot_3 <- vtm_total_canopy_plot_3 %>% 
  mutate(percent_canopy_cover_nonoverlap = (100*(1-(e^(-.01*percent_canopy_cover)))))
# I THINK it's okay to do this step here (after I've summed the canopy cover per plot), but I can go back and check if applying this equation earlier on changes our results. 
```

# Summarize findings (3)
```{r}
# with canopy overlap
# average percent canopy cover across all YPMC plots when allowing for canopy overlap
mean(vtm_total_canopy_plot_3$percent_canopy_cover) 
# 67.31387 WITHOUT OAKS
# 88.81102 with oaks
#  100.6753 -- this was the mean when we used the mean + 1SD for the 36+ size class. So it did go down a bit

canopy_cover_overlap_3<- vtm_total_canopy_plot_3 %>% 
  mutate (national_forest_name = "All Plots") %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover),
    sd = sd(percent_canopy_cover),
    sample_size = n(),
    se = sd(percent_canopy_cover)/sqrt(n()),
    var = var(percent_canopy_cover))

canopy_cover_overlap_forests_3 <- vtm_total_canopy_plot_3 %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover),
    sd = sd(percent_canopy_cover),
    sample_size = n(),
    se = sd(percent_canopy_cover)/sqrt(n()),
    var = var(percent_canopy_cover))

canopy_cover_overlap_summary_3 <- do.call("rbind", list(canopy_cover_overlap_3,
                                          canopy_cover_overlap_forests_3))

## -----------------------------------------------------------------------------------------------
# without canopy overlap
# average percent canopy cover across all YPMC plots when removing for canopy overlap
mean(vtm_total_canopy_plot_3$percent_canopy_cover_nonoverlap) 
# 43.04919 WITHOUT oaks
# 51.08581 not much different then before - With oaks
# old mean = 54.9521

canopy_cover_nonoverlap_3 <- vtm_total_canopy_plot_3 %>% 
  mutate (national_forest_name = "All Plots") %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

canopy_cover_nonoverlap_forests_3 <- vtm_total_canopy_plot_3 %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

canopy_cover_nonoverlap_summary_3 <- do.call("rbind", list(canopy_cover_nonoverlap_3,
                                          canopy_cover_nonoverlap_forests_3))
```

# Make graphs (3)
```{r}
# create final dataframe for graph
canopy_cover_nonoverlap_summary_rm_NA_3 <-canopy_cover_nonoverlap_summary_3 %>% 
  mutate(color = case_when(national_forest_name == "All Plots" ~ "1",
                           national_forest_name == "anf" ~ "0",
                           national_forest_name == "cnf" ~ "0",
                           national_forest_name == "lpnf" ~ "0",
                           national_forest_name == "sbnf" ~ "0",
                           national_forest_name == "N/A" ~ "0",
                           TRUE ~ "none"))
canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name == "anf"] <-"ANF"
canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name == "cnf"] <-"CNF"
canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name == "lpnf"] <-"LPNF"
canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name == "sbnf"] <-"SBNF"
canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name == "N/A"] <-"Other"
canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name[canopy_cover_nonoverlap_summary_rm_NA_3$national_forest_name == "All Plots"] <-"All YPMC"

# make factors
x_factor <- c("ANF", "CNF", "LPNF", "SBNF","Other", "All YPMC")
color_factor <- c("0", "1")

 ggplot(canopy_cover_nonoverlap_summary_rm_NA_3,aes(x=factor(national_forest_name, x_factor),y=mean, fill=factor(color, color_factor)))+
   scale_fill_manual(values = c("#636161", "#A00D35"))+
  geom_col(stat="identity",position=position_dodge(width = 0.4), width = 0.4)+
  geom_point(data = canopy_cover_nonoverlap_summary_rm_NA_3, aes(x=national_forest_name, y= mean),position=position_dodge(width = 0.4), color = "black", size = 1.3, shape = 16)+
geom_errorbar(data = canopy_cover_nonoverlap_summary_rm_NA_3,
              position=position_dodge(width = 0.4),
                aes(x = national_forest_name, 
                    ymin = mean - se,
                    ymax = mean + se),
                color = "black",
                width = 0.08) +
  theme_bw()+
  labs(title = "Average Percent Canopy Cover of YPMC", x = "Location", y = "Percent Canopy Cover") +
  theme(plot.title = element_text(hjust= 0.5,
                                  face = "bold",
                                  margin=margin(0,0,10,0))) +
  theme(axis.title.x = element_text (face = "bold",
                                     margin=margin(10,0,0,0))) +
  theme(axis.title.y = element_text (face = "bold",
                                     margin=margin(0,10,0,0)))+
  scale_y_continuous( expand = c(0,0))+
  expand_limits(y = c(0, 70))+
  theme(axis.text.x = element_text(color = "black", size = 9))+
  theme(legend.position = "none")
```


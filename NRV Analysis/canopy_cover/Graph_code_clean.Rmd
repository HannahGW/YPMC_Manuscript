---
title: "graph code"
author: "Hannah Garcia"
date: "2/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidyr)
library(here)
```

# Read in data
```{r}
# VTM
vtm_data <- read.table(here::here("vtm_data", "vtm_dataset_750m_buffer_FINAL.txt"))%>%
  mutate_if(is.numeric, ~replace(., is.na(.), 0))%>%
  mutate(n= dbh_4_11 + dbh_12_23 + dbh_24_35 +dbh_36)

# FIA
fia_data <- read_csv(here::here("FIA Data", "Final FIA data and code used for analysis", "final_binded_fia_ypmc_data.csv")) %>%
  filter(dbh >= 10.2) 

fia_data$admin_forest[fia_data$admin_forest == "LPF"] <-"LPNF"
fia_data$admin_forest[fia_data$admin_forest == "BDF"] <-"SBNF"
fia_data$admin_forest[fia_data$admin_forest == "Not NF or other NF"] <- "Other"
```

# Assign Constants
```{r}
# Sugar Pine (PILA) constants:
pila_d1 <- 3.5
pila_d2 <- 0.338
pila_a1 <- -1.476
pila_a2 <- 1.01
pila_s1 <- 0.7778

# White fir (ABCO) constants:
abco_d1 <- 3.26
abco_d2 <- 1.103
abco_a1 <- 5.82
abco_a2 <- 0.591
abco_s1 <- 0.7778

# Incense Cedar (CADE) constants:
cade_d1 <- 3.5
cade_d2 <- 1.192
cade_a1 <- 7.11
cade_a2 <- 0.47
cade_s1 <- 0.7778

# Jeffrey Pine (PIJE) constants: 
pije_d1 <- 3.5
pije_d2 <- 0.5754
pije_a1 <- 1.52
pije_a2 <- 0.891
pije_s1 <- 0.7778

# Ponderosa Pine (PIPO) constants:
pipo_d1 <- 3.77
pipo_d2 <- 0.7756
pipo_a1 <- 2.24
pipo_a2 <- 0.763
pipo_s1 <- 0.7778

# Coulter Pine (PICO) constants:
pico_d1 <- 3.5
pico_d2 <- 1.7618
pico_a1 <- 3.9347
pico_a2 <- 0.7086
pico_s1 <- 0.7778

# Bigcone Spruce (PSMA) constants
psma_d1 <- 3.5
psma_d2 <- 5.5672
psma_a1 <- 27.030
psma_a2 <- 0.8612
psma_s1 <- 0.7778

# Canyon Live Oak (QUCH) constants:
quch_d1 <- 2.5
quch_d2 <- 2.19
quch_a1 <- 5
quch_a2 <- 1.69
quch_s1 <- 0.5556

# Black Oak (QUKE) constants:
quke_d1 <- 2.5
quke_d2 <- 2.7
quke_a1 <- 10
quke_a2 <- 1.2
quke_s1 <- 0.5556

pi <- 3.1415926535 
e <- 2.718281828 
```

# VTM Canopy Cover (using midpoints and 36 as 36+ size class midpoint)
## PIPO Canopy Cover 
```{r}
# Use Equation 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
# DBH(subT) is 5 and our lowest dbh is 7.5 since we are taking the midpoint of each class. 

vtm_pipo <- vtm_data %>%
  filter(abbreviation == "PIPO") %>%
  select(plotkey, abbreviation, n,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent)%>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36")) 

# change dbh_class & canopy_cover to numeric
vtm_pipo$dbh_class <- as.numeric(vtm_pipo$dbh_class)
# str(vtm_pipo)
vtm_pipo <- mutate(vtm_pipo, canopy_width = (pipo_a1 * (dbh_class^(pipo_a2)))) 
vtm_pipo$canopy_width <- as.numeric(vtm_pipo$canopy_width)

vtm_pipo_canopy <- vtm_pipo %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2))
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pipo_sum <- vtm_pipo_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area)  
```

## PIJE Canopy Cover
```{r}
# Equation for PIJE: # 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
vtm_pije <- vtm_data %>%
  filter(abbreviation == "PIJE") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_pije$dbh_class <- as.numeric(vtm_pije$dbh_class)
vtm_pije <- mutate(vtm_pije, canopy_width = (pije_a1 * (dbh_class^(pije_a2))))
vtm_pije$canopy_width <- as.numeric(vtm_pije$canopy_width)

## ------------------------------------------------------------------------------------------------
# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_pije_canopy <- vtm_pije %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pije_sum <- vtm_pije_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

## PILA Canopy Cover
```{r}
# Use Equation: # 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
vtm_pila <- vtm_data %>%
  filter(abbreviation == "PILA") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_pila$dbh_class <- as.numeric(vtm_pila$dbh_class)
vtm_pila <- mutate(vtm_pila, canopy_width = (pila_a1 + pila_a2 * (dbh_class)))
vtm_pila$canopy_width <- as.numeric(vtm_pila$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_pila_canopy <- vtm_pila %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pila_sum <- vtm_pila_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

## PICO Canopy Cover
```{r}
# Use Equation 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
vtm_pico <- vtm_data %>%
  filter(abbreviation == "PICO3") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_pico$dbh_class <- as.numeric(vtm_pico$dbh_class)
vtm_pico <- mutate(vtm_pico, canopy_width = (pico_a1 * (dbh_class^(pico_a2))))
vtm_pico$canopy_width <- as.numeric(vtm_pico$canopy_width)

## ------------------------------------------------------------------------------------------------

vtm_pico_canopy <- vtm_pico %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_pico_sum <- vtm_pico_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

## ABCO Canopy Cover
```{r}
# # White fir (ABCO), Equation 4.4.2.1, DBH(subT) = 5
# # 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_abco <- vtm_data %>%
  filter(abbreviation == "ABCO") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_abco$dbh_class <- as.numeric(vtm_abco$dbh_class)
vtm_abco <- mutate(vtm_abco, canopy_width = (abco_a1 + abco_a2 * (dbh_class)))
vtm_abco$canopy_width <- as.numeric(vtm_abco$canopy_width)

## ------------------------------------------------------------------------------------------------

vtm_abco_canopy <- vtm_abco %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_abco_sum <- vtm_abco_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

## CADE Canopy Cover
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_cade <- vtm_data %>%
  filter(abbreviation == "CADE") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_cade$dbh_class <- as.numeric(vtm_cade$dbh_class)
vtm_cade <- mutate(vtm_cade, canopy_width = (cade_a1 + cade_a2 * (dbh_class)))
vtm_cade$canopy_width <- as.numeric(vtm_cade$canopy_width)

## ------------------------------------------------------------------------------------------------

vtm_cade_canopy <- vtm_cade %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_cade_sum <- vtm_cade_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

## PSMA Canopy Cover
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
vtm_psma <- vtm_data %>%
  filter(abbreviation == "PSMA") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_psma$dbh_class <- as.numeric(vtm_psma$dbh_class)
vtm_psma <- mutate(vtm_psma, canopy_width = (psma_a1 + psma_a2 * (dbh_class)))
vtm_psma$canopy_width <- as.numeric(vtm_psma$canopy_width)

## ------------------------------------------------------------------------------------------------# Find canopy area based off of the known canopy widths. Canopy area =  the area of a circle with diameter equal to the determined crown width. The area of a circle is A = (pi)* r^2. 

vtm_psma_canopy <- vtm_psma %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_psma_sum <- vtm_psma_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

## QUCH Canopy Cover
```{r}
# Use Equation  4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_quch <- vtm_data %>%
  filter(abbreviation == "QUCH") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count") %>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_quch$dbh_class <- as.numeric(vtm_quch$dbh_class)
vtm_quch <- mutate(vtm_quch, canopy_width = (quch_a1 + quch_a2 * (dbh_class)))
vtm_quch$canopy_width <- as.numeric(vtm_quch$canopy_width)

## ------------------------------------------------------------------------------------------------

vtm_quch_canopy <- vtm_quch %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_quch_sum <- vtm_quch_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

## QUKE Canopy Cover
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)

vtm_quke <- vtm_data %>%
  filter(abbreviation == "QUKE") %>%
  select(plotkey, abbreviation,
         dbh_4_11, dbh_12_23, dbh_24_35, dbh_36,
         national_forest_name,
         elevation, exposure, slope_percent) %>%
  pivot_longer('dbh_4_11':'dbh_36',
               names_to = "dbh_class",
               values_to = "dbh_count")%>%
  filter(dbh_count !=0) %>%
  uncount(dbh_count) %>%
  mutate(dbh_class = case_when(
    dbh_class == "dbh_4_11" ~ "7.5",
    dbh_class == "dbh_12_23" ~ "17.5",
    dbh_class == "dbh_24_35" ~ "29.5",
    dbh_class == "dbh_36" ~ "36"))

vtm_quke$dbh_class <- as.numeric(vtm_quke$dbh_class)
vtm_quke <- mutate(vtm_quke, canopy_width = (quke_a1 + quke_a2 * (dbh_class)))
vtm_quke$canopy_width <- as.numeric(vtm_quke$canopy_width)

## ------------------------------------------------------------------------------------------------

vtm_quke_canopy <- vtm_quke %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2)) 
# canopy_area is now in feet^2

## ------------------------------------------------------------------------------------------------
# sum canopy cover across all size classes for each plot
vtm_quke_sum <- vtm_quke_canopy %>%
  group_by(plotkey, dbh_class, abbreviation, national_forest_name) %>%
  tally(canopy_area) 
```

## Combine all dataframes to calculate relative canopy cover 
```{r}
# combine all species dataframes back together so we can sum the species in plots
vtm_total_canopy <- do.call("rbind", list(vtm_abco_sum,
                                          vtm_cade_sum,
                                          vtm_pico_sum,
                                          vtm_pije_sum,
                                          vtm_pila_sum,
                                          vtm_pipo_sum,
                                          vtm_psma_sum,
                                          vtm_quch_sum,
                                          vtm_quke_sum)) 

# n = the area (ft^2) covered by the canopies of all the trees in that size class/species/plot
## ------------------------------------------------------------------------------------------------

# Next we can sum the total canopy cover of all trees from all size classes PER PLOT
vtm_total_canopy_plot <- vtm_total_canopy %>% 
  group_by(plotkey, national_forest_name) %>% 
  tally(n) %>% 
  rename("total_canopy_area" = "n" )
# this checks out! There are 195 unique vtm plots! Leana checked a few plots and it looks good!
## ------------------------------------------------------------------------------------------------

# right now the total_canopy_area column is in ft^2, we want to convert this to m^2. 
# 1 ft^2 = 0.092903 m^2

# create a column that converts squared feet to squared meters
vtm_total_canopy_plot <- vtm_total_canopy_plot %>% 
  mutate(total_canopy_area_meters = (total_canopy_area *0.092903))


vtm_total_canopy_plot <- vtm_total_canopy_plot %>% 
  mutate(percent_canopy_cover = ((total_canopy_area_meters/809) * 100))

## ------------------------------------------------------------------------------------------------
vtm_total_canopy_plot <- vtm_total_canopy_plot %>% 
  mutate(percent_canopy_cover_nonoverlap = (100*(1-(e^(-.01*percent_canopy_cover)))))
```

## Summarize Findings
```{r}
canopy_cover_nonoverlap <- vtm_total_canopy_plot %>% 
  mutate (national_forest_name = "Total") %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    median = median(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

canopy_cover_nonoverlap_forests <- vtm_total_canopy_plot %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    median = median(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

vtm_canopy_cover_nonoverlap_summary <- do.call("rbind", list(canopy_cover_nonoverlap,
                                          canopy_cover_nonoverlap_forests))

vtm_canopy_cover_nonoverlap_summary$national_forest_name[vtm_canopy_cover_nonoverlap_summary$national_forest_name == "anf"] <-"ANF"
vtm_canopy_cover_nonoverlap_summary$national_forest_name[vtm_canopy_cover_nonoverlap_summary$national_forest_name == "cnf"] <-"CNF"
vtm_canopy_cover_nonoverlap_summary$national_forest_name[vtm_canopy_cover_nonoverlap_summary$national_forest_name == "lpnf"] <-"LPNF"
vtm_canopy_cover_nonoverlap_summary$national_forest_name[vtm_canopy_cover_nonoverlap_summary$national_forest_name == "sbnf"] <-"SBNF"
vtm_canopy_cover_nonoverlap_summary$national_forest_name[vtm_canopy_cover_nonoverlap_summary$national_forest_name == "N/A"] <-"Other"

```

# FIA Canopy Cover
## PIPO Canopy Cover
```{r}
# Use Equation 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
# DBH(subT) is 5 and our lowest dbh is 7.5 since we are taking the midpoint of each class. 

fia_pipo_36 <- fia_data %>%
  filter(species == "PIPO") %>%
  select(unique_plot, dbh, ht,
         admin_forest, species) %>%
  mutate(dbh_class = case_when (dbh >= 10.2 & dbh <= 30.4 ~"7.5",
                                dbh > 30.4 & dbh <= 60.9 ~ "17.5",
                                dbh > 60.9 & dbh <= 91.3 ~ "29.5",
                                dbh > 91.3 ~ "36")) 

# change dbh_class to numeric (note, anything greater than 36 dbh won't have a plus or else they would change to NAs when converted to numeric)
fia_pipo_36$dbh_class <- as.numeric(fia_pipo_36$dbh_class)
# str(fia_pipo)
fia_pipo_36 <- mutate(fia_pipo_36, canopy_width = (pipo_a1 * (dbh_class^(pipo_a2))))
fia_pipo_36$canopy_width <- as.numeric(fia_pipo_36$canopy_width)

## -------------------------------------------------------------------------------------------------
fia_pipo_canopy_36 <- fia_pipo_36 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2))

## -------------------------------------------------------------------------------------------------
# sum across all size classes for each plot
fia_pipo_sum_36 <- fia_pipo_canopy_36 %>%
  group_by(unique_plot, dbh_class, admin_forest, species)%>%
  tally(canopy_area) 
```

## PIJE Canopy cover
```{r}
# Equation for PIJE: # 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
fia_pije_36 <- fia_data %>%
  filter(species == "PIJE") %>%
  select(unique_plot, dbh, ht,
         admin_forest, species) %>%
  mutate(dbh_class = case_when (dbh >= 10.2 & dbh <= 30.4 ~"7.5",
                                dbh > 30.4 & dbh <= 60.9 ~ "17.5",
                                dbh > 60.9 & dbh <= 91.3 ~ "29.5",
                                dbh > 91.3 ~ "36")) 

fia_pije_36$dbh_class <- as.numeric(fia_pije_36$dbh_class)
fia_pije_36 <- mutate(fia_pije_36, canopy_width = (pije_a1 * (dbh_class^(pije_a2))))
fia_pije_36$canopy_width <- as.numeric(fia_pije_36$canopy_width)

## -------------------------------------------------------------------------------------------------
fia_pije_canopy_36 <- fia_pije_36 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2))

## -------------------------------------------------------------------------------------------------
# sum across all size classes for each plot
fia_pije_sum_36 <- fia_pije_canopy_36 %>%
  group_by(unique_plot, dbh_class, species, admin_forest) %>%
  tally(canopy_area) 
```

## PILA Canopy Cover 
```{r}
# Use Equation: # 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
fia_pila_36 <- fia_data %>%
  filter(species == "PILA") %>%
  select(unique_plot, dbh, ht,
         admin_forest, species) %>%
  mutate(dbh_class = case_when (dbh >= 10.2 & dbh <= 30.4 ~"7.5",
                                dbh > 30.4 & dbh <= 60.9 ~ "17.5",
                                dbh > 60.9 & dbh <= 91.3 ~ "29.5",
                                dbh > 91.3 ~ "36")) 

fia_pila_36$dbh_class <- as.numeric(fia_pila_36$dbh_class)
fia_pila_36 <- mutate(fia_pila_36, canopy_width = (pila_a1 + pila_a2 * (dbh_class))) 
fia_pila_36$canopy_width <- as.numeric(fia_pila_36$canopy_width)

## -------------------------------------------------------------------------------------------------
fia_pila_canopy_36 <- fia_pila_36 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2))

## -------------------------------------------------------------------------------------------------
# sum across all size classes for each plot
fia_pila_sum_36 <- fia_pila_canopy_36 %>%
  group_by(unique_plot, dbh_class, species, admin_forest) %>%
  tally(canopy_area) 
```

## PICO Canopy Cover 
```{r}
# Use Equation 4.4.2.2: CW = a1 * DBH^a2 (DBH>=DBHT)
fia_pico_36 <- fia_data %>%
  filter(species == "PICO") %>%
  select(unique_plot, dbh, ht,
         admin_forest, species) %>%
  mutate(dbh_class = case_when (dbh >= 10.2 & dbh <= 30.4 ~"7.5",
                                dbh > 30.4 & dbh <= 60.9 ~ "17.5",
                                dbh > 60.9 & dbh <= 91.3 ~ "29.5",
                                dbh > 91.3 ~ "36")) 

fia_pico_36$dbh_class <- as.numeric(fia_pico_36$dbh_class)
fia_pico_36 <- mutate(fia_pico_36, canopy_width = (pico_a1 * (dbh_class^(pico_a2))))
fia_pico_36$canopy_width <- as.numeric(fia_pico_36$canopy_width)

## -------------------------------------------------------------------------------------------------
fia_pico_canopy_36 <- fia_pico_36 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2))

## -------------------------------------------------------------------------------------------------
# sum across all size classes for each plot
fia_pico_sum_36 <- fia_pico_canopy_36 %>%
  group_by(unique_plot, dbh_class, species, admin_forest) %>%
  tally(canopy_area) 
```

## ABCO Canopy Cover 
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
fia_abco_36 <- fia_data %>%
  filter(species == "ABCO") %>%
  select(unique_plot, dbh, ht,
         admin_forest, species) %>%
  mutate(dbh_class = case_when (dbh >= 10.2 & dbh <= 30.4 ~"7.5",
                                dbh > 30.4 & dbh <= 60.9 ~ "17.5",
                                dbh > 60.9 & dbh <= 91.3 ~ "29.5",
                                dbh > 91.3 ~ "36")) 

fia_abco_36$dbh_class <- as.numeric(fia_abco_36$dbh_class)
fia_abco_36 <- mutate(fia_abco_36, canopy_width = (abco_a1 + abco_a2 * (dbh_class)))
fia_abco_36$canopy_width <- as.numeric(fia_abco_36$canopy_width)

## -------------------------------------------------------------------------------------------------
fia_abco_canopy_36 <- fia_abco_36 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2))

## -------------------------------------------------------------------------------------------------
# sum across all size classes for each plot
fia_abco_sum_36 <- fia_abco_canopy_36 %>%
  group_by(unique_plot, dbh_class, species, admin_forest) %>%
  tally(canopy_area) 
```

## CADE Canopy Cover 
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
fia_cade_36 <- fia_data %>%
  filter(species == "CADE") %>%
  select(unique_plot, dbh, ht,
         admin_forest, species) %>%
  mutate(dbh_class = case_when (dbh >= 10.2 & dbh <= 30.4 ~"7.5",
                                dbh > 30.4 & dbh <= 60.9 ~ "17.5",
                                dbh > 60.9 & dbh <= 91.3 ~ "29.5",
                                dbh > 91.3 ~ "36")) 

fia_cade_36$dbh_class <- as.numeric(fia_cade_36$dbh_class)
fia_cade_36 <- mutate(fia_cade_36, canopy_width = (cade_a1 + cade_a2 * (dbh_class)))
fia_cade_36$canopy_width <- as.numeric(fia_cade_36$canopy_width)

## -------------------------------------------------------------------------------------------------
fia_cade_canopy_36 <- fia_cade_36 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2))

## -------------------------------------------------------------------------------------------------
# sum across all size classes for each plot
fia_cade_sum_36 <- fia_cade_canopy_36 %>%
  group_by(unique_plot, dbh_class, species, admin_forest) %>%
  tally(canopy_area) 
```

## PSMA Canopy Cover 
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
fia_psma_36 <- fia_data %>%
  filter(species == "PSMA") %>%
  select(unique_plot, dbh, ht,
         admin_forest, species) %>%
  mutate(dbh_class = case_when (dbh >= 10.2 & dbh <= 30.4 ~"7.5",
                                dbh > 30.4 & dbh <= 60.9 ~ "17.5",
                                dbh > 60.9 & dbh <= 91.3 ~ "29.5",
                                dbh > 91.3 ~ "36")) 

fia_psma_36$dbh_class <- as.numeric(fia_psma_36$dbh_class)
fia_psma_36 <- mutate(fia_psma_36, canopy_width = (psma_a1 + psma_a2 * (dbh_class)))
fia_psma_36$canopy_width <- as.numeric(fia_psma_36$canopy_width)

## -------------------------------------------------------------------------------------------------
fia_psma_canopy_36 <- fia_psma_36 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2))

## -------------------------------------------------------------------------------------------------
# sum across all size classes for each plot
fia_psma_sum_36 <- fia_psma_canopy_36 %>%
  group_by(unique_plot, dbh_class, species, admin_forest) %>%
  tally(canopy_area) 
```

## QUCH Canopy Cover 
```{r}
# Use Equation  4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
fia_quch_36 <- fia_data %>%
  filter(species == "QUCH") %>%
  select(unique_plot, dbh, ht,
         admin_forest, species) %>%
  mutate(dbh_class = case_when (dbh >= 10.2 & dbh <= 30.4 ~"7.5",
                                dbh > 30.4 & dbh <= 60.9 ~ "17.5",
                                dbh > 60.9 & dbh <= 91.3 ~ "29.5",
                                dbh > 91.3 ~ "36")) 

fia_quch_36$dbh_class <- as.numeric(fia_quch_36$dbh_class)
fia_quch_36 <- mutate(fia_quch_36, canopy_width = (quch_a1 + quch_a2 * (dbh_class)))
fia_quch_36$canopy_width <- as.numeric(fia_quch_36$canopy_width)

## -------------------------------------------------------------------------------------------------
fia_quch_canopy_36 <- fia_quch_36 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2))

## -------------------------------------------------------------------------------------------------
# sum across all size classes for each plot
fia_quch_sum_36 <- fia_quch_canopy_36 %>%
  group_by(unique_plot, dbh_class, species, admin_forest) %>%
  tally(canopy_area) 
```

## QUKE Canopy Cover 
```{r}
# Use Equation 4.4.2.1: CW = a1 + a2 * DBH (DBH>=DBHT)
fia_quke_36 <- fia_data %>%
  filter(species == "QUKE") %>%
  select(unique_plot, dbh, ht,
         admin_forest, species) %>%
  mutate(dbh_class = case_when (dbh >= 10.2 & dbh <= 30.4 ~"7.5",
                                dbh > 30.4 & dbh <= 60.9 ~ "17.5",
                                dbh > 60.9 & dbh <= 91.3 ~ "29.5",
                                dbh > 91.3 ~ "36")) 

fia_quke_36$dbh_class <- as.numeric(fia_quke_36$dbh_class)
fia_quke_36 <- mutate(fia_quke_36, canopy_width = (quke_a1 + quke_a2 * (dbh_class)))
fia_quke_36$canopy_width <- as.numeric(fia_quke_36$canopy_width)

## -------------------------------------------------------------------------------------------------
fia_quke_canopy_36 <- fia_quke_36 %>%
  mutate(canopy_area = (pi) * ((0.5 * canopy_width)^2))

## -------------------------------------------------------------------------------------------------
# sum across all size classes for each plot
fia_quke_sum_36 <- fia_quke_canopy_36 %>%
  group_by(unique_plot, dbh_class, species, admin_forest) %>%
  tally(canopy_area) 
```

## Combine all dataframes
```{r}
# combine all species dataframes back together so we can sum the species in plots
fia_total_canopy <- do.call("rbind", list(fia_abco_sum_36,
                                          fia_cade_sum_36,
                                          fia_pico_sum_36,
                                          fia_pije_sum_36,
                                          fia_pila_sum_36,
                                          fia_pipo_sum_36,
                                          fia_psma_sum_36,
                                          fia_quch_sum_36,
                                          fia_quke_sum_36))

## -------------------------------------------------------------------------------------------------
# Next we can sum the total canopy cover of all trees from all size classes PER PLOT
fia_total_canopy_plot <- fia_total_canopy %>% 
  group_by(unique_plot, admin_forest) %>% 
  tally(n) %>% 
  rename("total_canopy_area" = "n" )

## ------------------------------------------------------------------------------------------------

# create a column that converts squared feet to squared meters
fia_total_canopy_plot <- fia_total_canopy_plot %>% 
  mutate(total_canopy_area_meters = (total_canopy_area *0.092903))

fia_total_canopy_plot <- fia_total_canopy_plot %>% 
  mutate(percent_canopy_cover = ((total_canopy_area_meters/672.45) * 100))

fia_total_canopy_plot <- fia_total_canopy_plot %>% 
  mutate(percent_canopy_cover_nonoverlap = (100*(1-(e^(-.01*percent_canopy_cover)))))
```

## Summarize Findings
```{r}
fia_canopy_cover_nonoverlap <- fia_total_canopy_plot %>% 
  mutate (admin_forest = "Total") %>% 
  group_by(admin_forest) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    median = median(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

fia_canopy_cover_nonoverlap_forests <- fia_total_canopy_plot %>% 
  group_by(admin_forest) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    median = median(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

fia_canopy_cover_nonoverlap_summary <- do.call("rbind", list(fia_canopy_cover_nonoverlap,
                                          fia_canopy_cover_nonoverlap_forests)) %>% 
  rename("national_forest_name" = "admin_forest")
```

# Comparison graph INCLUDING Oaks
```{r}
# VTM: vtm_canopy_cover_nonoverlap_summary
# FIA: fia_canopy_cover_nonoverlap_summary

vtm_canopy_cover_nonoverlap_summary <- vtm_canopy_cover_nonoverlap_summary %>% 
  mutate(plot = case_when(national_forest_name == "ANF" ~ "VTM",
                          national_forest_name == "CNF" ~ "VTM",
                          national_forest_name == "SBNF" ~ "VTM",
                          national_forest_name == "LPNF" ~ "VTM",
                          national_forest_name == "Other" ~ "VTM",
                          national_forest_name == "Total" ~ "VTM",
                          TRUE ~ "none"))
  

fia_canopy_cover_nonoverlap_summary <- fia_canopy_cover_nonoverlap_summary %>% 
  mutate(plot = case_when(national_forest_name == "ANF" ~ "FIA",
                          national_forest_name == "CNF" ~ "FIA",
                          national_forest_name == "SBNF" ~ "FIA",
                          national_forest_name == "LPNF" ~ "FIA",
                          national_forest_name == "Other" ~ "FIA",
                          national_forest_name == "Total" ~ "FIA",
                          TRUE ~ "none")) 

comparison_w_oaks <- do.call("rbind", list(vtm_canopy_cover_nonoverlap_summary,
                                      fia_canopy_cover_nonoverlap_summary))

comparison_no_cnf <- comparison_w_oaks %>% 
  filter(national_forest_name %in% c("ANF", "LPNF", "SBNF", "Total"))

w_oaks_cnf <- comparison_w_oaks %>% 
  filter(national_forest_name %in% c("ANF","CNF", "LPNF", "SBNF", "Total"))
```

## Graph INCLUDING OAKS
```{r}
x_factor <- c("ANF", "LPNF", "SBNF", "Total")
color_factor <- c("0", "1")
order_factor <- c("VTM", "FIA")

ggplot(comparison_w_oaks,
       aes(x=factor(national_forest_name, x_factor),
           y=mean, fill=factor(plot, order_factor))) +
   scale_fill_manual(values = c("#8EBB90", "#1D734D"),
                     labels=c("Historic (VTM)", "Current (FIA)"), name= "") +
  geom_col(stat="identity",
           position=position_dodge(width = 0.7),
           width = 0.7) +
    geom_point(data = comparison_w_oaks,
             aes(x=national_forest_name, y= mean),
             position=position_dodge(width = 0.7),
             color = "black", size = 1.3, shape = 16, show.legend = FALSE) +
  geom_point(data = comparison_w_oaks, 
             aes(x = national_forest_name, y = median), 
             position=position_dodge(width=0.7), 
             vjust=-0.3, shape = 4,
             show.legend = FALSE) +
geom_errorbar(data = comparison_w_oaks,
              position=position_dodge(width = 0.7),
                aes(x = national_forest_name, 
                    ymin = mean - se,
                    ymax = mean + se),
                color = "black",
                width = 0.3) +
  theme_bw() +
  labs(x = "National Forest", y = "Percent Cover") +
  theme(plot.title = element_text(hjust= 0.5,
                                  face = "bold",
                                  margin=margin(0,0,10,0))) +
  theme(plot.subtitle = element_text(hjust= 0.5,
                                  margin=margin(0,0,10,0))) +
  theme(axis.title.x = element_text(face = "bold", size =13,
                                     margin=margin(10,0,0,0))) +
  theme(axis.title.y = element_text (face = "bold", size = 13,
                                     margin=margin(0,10,0,0)))+
  scale_y_continuous(expand = c(0,0)) +
  expand_limits(y = c(0,90)) +
  theme(axis.text.x = element_text(color = "black", size = 9)) +
  theme(legend.title = element_blank()) +
  theme(legend.text=element_text(size=9))
  # ggsave(here::here("NRV Analysis", "canopy_cover", "Figures", "FINAL_with_oaks.png"),
  #        height=5,
  #        width=7,
  #        units="in")
```

## INCLUDING OAKS with CNF
```{r}
x_factor <- c("ANF","CNF", "LPNF", "SBNF", "Total")
color_factor <- c("0", "1")
order_factor <- c("VTM", "FIA")

ggplot(w_oaks_cnf,
       aes(x=factor(national_forest_name, x_factor),
           y=mean, fill=factor(plot, order_factor))) +
   scale_fill_manual(values = c("#8EBB90", "#1D734D"),
                     labels=c("Historic (VTM)", "Current (FIA)"), name= "") +
  geom_col(stat="identity",
           position=position_dodge(width = 0.7),
           width = 0.7) +
  geom_point(data = w_oaks_cnf, 
             aes(x = national_forest_name, y = median), 
             position=position_dodge(width=0.7), 
             vjust=-0.3, shape = 4,
             show.legend = FALSE) +
  geom_point(data = w_oaks_cnf,
             aes(x=national_forest_name, y= mean),
             position=position_dodge(width = 0.7),
             color = "black", size = 1.3, shape = 16, show.legend = FALSE) +
geom_errorbar(data = w_oaks_cnf,
              position=position_dodge(width = 0.7),
                aes(x = national_forest_name, 
                    ymin = mean - se,
                    ymax = mean + se),
                color = "black",
                width = 0.3) +
  theme_bw() +
  labs(x = "National Forest", y = "Percent Cover") +
  theme(plot.title = element_text(hjust= 0.5,
                                  face = "bold",
                                  margin=margin(0,0,10,0))) +
  theme(plot.subtitle = element_text(hjust= 0.5,
                                  margin=margin(0,0,10,0))) +
  theme(axis.title.x = element_text(face = "bold", size =13,
                                     margin=margin(10,0,0,0))) +
  theme(axis.title.y = element_text (face = "bold", size = 13,
                                     margin=margin(0,10,0,0)))+
  scale_y_continuous(expand = c(0,0)) +
  expand_limits(y = c(0,90)) +
  theme(axis.text.x = element_text(color = "black", size = 9)) +
  theme(legend.title = element_blank()) +
  theme(legend.text=element_text(size=9)) +
  ggsave(here::here("NRV Analysis", "canopy_cover", "Figures", "FINAL_with_oaks_cnf.png"),
         height=5,
         width=7,
         units="in")
```

# Comparison graph EXCLUDING Oaks

```{r}
# Summarize VTM Data
vtm_total_canopy_no_oak <- do.call("rbind", list(vtm_abco_sum,
                                          vtm_cade_sum,
                                          vtm_pico_sum,
                                          vtm_pije_sum,
                                          vtm_pila_sum,
                                          vtm_pipo_sum,
                                          vtm_psma_sum))

vtm_total_canopy_no_oak <- vtm_total_canopy_no_oak %>% 
  group_by(plotkey, national_forest_name) %>% 
  tally(n) %>% 
  rename("total_canopy_area" = "n" )

# create a column that converts squared feet to squared meters
vtm_total_canopy_no_oak <- vtm_total_canopy_no_oak %>% 
  mutate(total_canopy_area_meters = (total_canopy_area *0.092903))


vtm_total_canopy_no_oak <- vtm_total_canopy_no_oak %>% 
  mutate(percent_canopy_cover = ((total_canopy_area_meters/809) * 100))

vtm_total_canopy_no_oak <- vtm_total_canopy_no_oak %>% 
  mutate(percent_canopy_cover_nonoverlap = (100*(1-(e^(-.01*percent_canopy_cover)))))

canopy_cover_nonoverlap_no_oak <- vtm_total_canopy_no_oak %>% 
  mutate (national_forest_name = "Total") %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    median = median(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

canopy_cover_nonoverlap_forests_no_oak <- vtm_total_canopy_no_oak %>% 
  group_by(national_forest_name) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    median = median(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

vtm_canopy_cover_nonoverlap_summary_no_oak <- do.call("rbind", list(canopy_cover_nonoverlap_no_oak,
                                          canopy_cover_nonoverlap_forests_no_oak))

vtm_canopy_cover_nonoverlap_summary_no_oak$national_forest_name[vtm_canopy_cover_nonoverlap_summary_no_oak$national_forest_name == "anf"] <-"ANF"
vtm_canopy_cover_nonoverlap_summary_no_oak$national_forest_name[vtm_canopy_cover_nonoverlap_summary_no_oak$national_forest_name == "cnf"] <-"CNF"
vtm_canopy_cover_nonoverlap_summary_no_oak$national_forest_name[vtm_canopy_cover_nonoverlap_summary_no_oak$national_forest_name == "lpnf"] <-"LPNF"
vtm_canopy_cover_nonoverlap_summary_no_oak$national_forest_name[vtm_canopy_cover_nonoverlap_summary_no_oak$national_forest_name == "sbnf"] <-"SBNF"
vtm_canopy_cover_nonoverlap_summary_no_oak$national_forest_name[vtm_canopy_cover_nonoverlap_summary_no_oak$national_forest_name == "N/A"] <-"Other"

## ------------------------------------------------------------------------------------------------

# Summarize FIA Data
fia_total_canopy_no_oak <- do.call("rbind", list(fia_abco_sum_36,
                                          fia_cade_sum_36,
                                          fia_pico_sum_36,
                                          fia_pije_sum_36,
                                          fia_pila_sum_36,
                                          fia_pipo_sum_36,
                                          fia_psma_sum_36))

fia_total_canopy_no_oak <- fia_total_canopy_no_oak %>% 
  group_by(unique_plot, admin_forest) %>% 
  tally(n) %>% 
  rename("total_canopy_area" = "n" )

fia_total_canopy_no_oak <- fia_total_canopy_no_oak %>% 
  mutate(total_canopy_area_meters = (total_canopy_area *0.092903))

fia_total_canopy_no_oak <- fia_total_canopy_no_oak %>% 
  mutate(percent_canopy_cover = ((total_canopy_area_meters/672.45) * 100))

fia_total_canopy_no_oak <- fia_total_canopy_no_oak %>% 
  mutate(percent_canopy_cover_nonoverlap = (100*(1-(e^(-.01*percent_canopy_cover)))))

fia_canopy_cover_nonoverlap_no_oak <- fia_total_canopy_no_oak %>% 
  mutate (admin_forest = "Total") %>% 
  group_by(admin_forest) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    median = median(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

fia_canopy_cover_nonoverlap_forests_no_oak <- fia_total_canopy_no_oak %>% 
  group_by(admin_forest) %>% 
  summarize(
    mean = mean(percent_canopy_cover_nonoverlap),
    median = median(percent_canopy_cover_nonoverlap),
    sd = sd(percent_canopy_cover_nonoverlap),
    sample_size = n(),
    se = sd(percent_canopy_cover_nonoverlap)/sqrt(n()),
    var = var(percent_canopy_cover_nonoverlap))

fia_canopy_cover_nonoverlap_summary_no_oak <- do.call("rbind", list(fia_canopy_cover_nonoverlap_no_oak,
                                          fia_canopy_cover_nonoverlap_forests_no_oak)) %>% 
  rename("national_forest_name" = "admin_forest")

```

## Set up data
```{r}
# VTM: vtm_canopy_cover_nonoverlap_summary_no_oak
# FIA: fia_canopy_cover_nonoverlap_summary_no_oak

vtm_canopy_cover_nonoverlap_summary_no_oak <- vtm_canopy_cover_nonoverlap_summary_no_oak %>% 
  mutate(plot = case_when(national_forest_name == "ANF" ~ "VTM",
                          national_forest_name == "CNF" ~ "VTM",
                          national_forest_name == "SBNF" ~ "VTM",
                          national_forest_name == "LPNF" ~ "VTM",
                          national_forest_name == "Other" ~ "VTM",
                          national_forest_name == "Total" ~ "VTM",
                          TRUE ~ "none"))
  

fia_canopy_cover_nonoverlap_summary_no_oak <- fia_canopy_cover_nonoverlap_summary_no_oak %>% 
  mutate(plot = case_when(national_forest_name == "ANF" ~ "FIA",
                          national_forest_name == "CNF" ~ "FIA",
                          national_forest_name == "SBNF" ~ "FIA",
                          national_forest_name == "LPNF" ~ "FIA",
                          national_forest_name == "Other" ~ "FIA",
                          national_forest_name == "Total" ~ "FIA",
                          TRUE ~ "none")) 

comparison_wo_oaks <- do.call("rbind", list(vtm_canopy_cover_nonoverlap_summary_no_oak,
                                      fia_canopy_cover_nonoverlap_summary_no_oak))

write.csv(comparison_wo_oaks, "cc_no_oak_df.csv", row.names=FALSE)

comparison_wo_oaks_no_cnf <- comparison_wo_oaks %>% 
  filter(national_forest_name %in% c("ANF", "LPNF", "SBNF", "Total"))

no_oaks_w_cnf <- comparison_wo_oaks %>% 
  filter(national_forest_name %in% c("ANF","CNF", "LPNF", "SBNF", "Total"))

no_oaks_total <- comparison_wo_oaks %>% 
  filter(national_forest_name == "Total")
```

## Graph EXCLUDING oaks
```{r}
x_factor <- c("ANF", "LPNF", "SBNF", "Total")
color_factor <- c("0", "1")
order_factor <- c("VTM", "FIA")

ggplot(comparison_wo_oaks_no_cnf,
       aes(x=factor(national_forest_name, x_factor),
           y=mean, fill=factor(plot, order_factor))) +
   scale_fill_manual(values = c("#8EBB90", "#1D734D"),
                     labels=c("Historic (VTM)", "Current (FIA)"), name= "") +
  geom_col(stat="identity",
           position=position_dodge(width = 0.7),
           width = 0.7) +
  geom_point(data = comparison_wo_oaks_no_cnf, 
             aes(x = national_forest_name, y = median), 
             position=position_dodge(width=0.7), 
             vjust=-0.3, shape = 4,
             show.legend = FALSE) +
  geom_point(data = comparison_wo_oaks_no_cnf,
             aes(x=national_forest_name, y= mean),
             position=position_dodge(width = 0.7),
             color = "black", size = 1.3, shape = 16, show.legend = FALSE) +
geom_errorbar(data = comparison_wo_oaks_no_cnf,
              position=position_dodge(width = 0.7),
                aes(x = national_forest_name, 
                    ymin = mean - se,
                    ymax = mean + se),
                color = "black",
                width = 0.3) +
  theme_bw() +
  labs(x = "National Forest", y = "Percent Cover") +
  theme(plot.title = element_text(hjust= 0.5,
                                  face = "bold",
                                  margin=margin(0,0,10,0))) +
  theme(plot.subtitle = element_text(hjust= 0.5,
                                  margin=margin(0,0,10,0))) +
  theme(axis.title.x = element_text(face = "bold", size =13,
                                     margin=margin(10,0,0,0))) +
  theme(axis.title.y = element_text (face = "bold", size = 13,
                                     margin=margin(0,10,0,0)))+
  scale_y_continuous(expand = c(0,0)) +
  expand_limits(y = c(0,90)) +
  theme(axis.text.x = element_text(color = "black", size = 9)) +
  theme(legend.title = element_blank()) +
  theme(legend.text=element_text(size=9)) +
  ggsave(here::here("NRV Analysis", "canopy_cover", "Figures", "FINAL_wo_oaks.png"),
         height=5,
         width=7,
         units="in")
```

## EXCLUDING OAKS with CNF
```{r}
x_factor <- c("ANF","CNF", "LPNF", "SBNF", "Total")
color_factor <- c("0", "1")
order_factor <- c("VTM", "FIA")

ggplot(no_oaks_w_cnf,
       aes(x=factor(national_forest_name, x_factor),
           y=mean, fill=factor(plot, order_factor))) +
   scale_fill_manual(values = c("#8EBB90", "#1D734D"),
                     labels=c("Historic (VTM)", "Current (FIA)"), name= "") +
  geom_col(stat="identity",
           position=position_dodge(width = 0.7),
           width = 0.7) +
  geom_point(data = no_oaks_w_cnf, 
             aes(x = national_forest_name, y = median), 
             position=position_dodge(width=0.7), 
             vjust=-0.3, shape = 4,
             show.legend = FALSE) +
  geom_point(data = no_oaks_w_cnf,
             aes(x=national_forest_name, y= mean),
             position=position_dodge(width = 0.7),
             color = "black", size = 1.3, shape = 16, show.legend = FALSE) +
geom_errorbar(data = no_oaks_w_cnf,
              position=position_dodge(width = 0.7),
                aes(x = national_forest_name, 
                    ymin = mean - se,
                    ymax = mean + se),
                color = "black",
                width = 0.3) +
  theme_bw() +
  labs(x = "National Forest", y = "Percent Cover") +
  theme(plot.title = element_text(hjust= 0.5,
                                  face = "bold",
                                  margin=margin(0,0,10,0))) +
  theme(plot.subtitle = element_text(hjust= 0.5,
                                  margin=margin(0,0,10,0))) +
  theme(axis.title.x = element_text(face = "bold", size =13,
                                     margin=margin(10,0,0,0))) +
  theme(axis.title.y = element_text (face = "bold", size = 13,
                                     margin=margin(0,10,0,0)))+
  scale_y_continuous(expand = c(0,0)) +
  expand_limits(y = c(0,90)) +
  theme(axis.text.x = element_text(color = "black", size = 9)) +
  theme(legend.title = element_blank()) +
  theme(legend.text=element_text(size=9)) +
  ggsave(here::here("NRV Analysis", "canopy_cover", "Figures", "FINAL_wo_oaks_cnf.png"),
         height=5,
         width=7,
         units="in")
```

# PUBLIC graphs
## with oaks
```{r}
# comparison_w_oaks

total_w_oaks <- comparison_w_oaks %>% 
  filter(national_forest_name == "Total")

color_factor <- c("0", "1")
order_factor <- c("VTM", "FIA")

ggplot(total_w_oaks,
       aes(x=factor(national_forest_name, x_factor),
           y=mean, fill=factor(plot, order_factor))) +
   scale_fill_manual(values = c("#8EBB90", "#1D734D"),
                     labels=c("Historic (VTM)", "Current (FIA)"), name= "") +
  geom_col(stat="identity",
           position=position_dodge(width = 0.7),
           width = 0.7) +
  geom_point(data = total_w_oaks, 
             aes(x = national_forest_name, y = median), 
             position=position_dodge(width=0.7), 
             vjust=-0.3, shape = 4,
             show.legend = FALSE) +
  geom_point(data = total_w_oaks,
             aes(x=national_forest_name, y= mean),
             position=position_dodge(width = 0.7),
             color = "black", size = 1.3, shape = 16, show.legend = FALSE) +
geom_errorbar(data = total_w_oaks,
              position=position_dodge(width = 0.7),
                aes(x = national_forest_name, 
                    ymin = mean - se,
                    ymax = mean + se),
                color = "black",
                width = 0.3) +
  theme_bw() +
  labs(x = "", y = "Percent Cover") +
  theme(plot.title = element_text(hjust= 0.5,
                                  face = "bold",
                                  margin=margin(0,0,10,0))) +
  theme(plot.subtitle = element_text(hjust= 0.5,
                                  margin=margin(0,0,10,0))) +
  theme(axis.title.x = element_text(face = "bold", size =13,
                                     margin=margin(10,0,0,0))) +
  theme(axis.title.y = element_text (face = "bold", size = 13,
                                     margin=margin(0,10,0,0)))+
  scale_y_continuous(expand = c(0,0)) +
  expand_limits(y = c(0,90)) +
  theme(axis.text.x = element_text(color = "black", size = 9)) +
  theme(legend.title = element_blank()) +
  theme(legend.text=element_text(size=9)) +
  ggsave(here::here("NRV Analysis", "canopy_cover", "Figures", "Publics_w_oaks.png"),
         height=5,
         width=7,
         units="in")

```

## without oaks
```{r}
# no_oaks_total

color_factor <- c("0", "1")
order_factor <- c("VTM", "FIA")

ggplot(no_oaks_total,
       aes(x=factor(national_forest_name, x_factor),
           y=mean, fill=factor(plot, order_factor))) +
   scale_fill_manual(values = c("#8EBB90", "#1D734D"),
                     labels=c("Historic (VTM)", "Current (FIA)"), name= "") +
  geom_col(stat="identity",
           position=position_dodge(width = 0.7),
           width = 0.7) +
  geom_point(data = no_oaks_total, 
             aes(x = national_forest_name, y = median), 
             position=position_dodge(width=0.7), 
             vjust=-0.3, shape = 4,
             show.legend = FALSE) +
  geom_point(data = no_oaks_total,
             aes(x=national_forest_name, y= mean),
             position=position_dodge(width = 0.7),
             color = "black", size = 1.3, shape = 16, show.legend = FALSE) +
geom_errorbar(data = no_oaks_total,
              position=position_dodge(width = 0.7),
                aes(x = national_forest_name, 
                    ymin = mean - se,
                    ymax = mean + se),
                color = "black",
                width = 0.3) +
  theme_bw() +
  labs(x = "", y = "Percent Cover") +
  theme(plot.title = element_text(hjust= 0.5,
                                  face = "bold",
                                  margin=margin(0,0,10,0))) +
  theme(plot.subtitle = element_text(hjust= 0.5,
                                  margin=margin(0,0,10,0))) +
  theme(axis.title.x = element_text(face = "bold", size =13,
                                     margin=margin(10,0,0,0))) +
  theme(axis.title.y = element_text (face = "bold", size = 13,
                                     margin=margin(0,10,0,0)))+
  scale_y_continuous(expand = c(0,0)) +
  expand_limits(y = c(0,90)) +
  theme(axis.text.x = element_text(color = "black", size = 9)) +
  theme(legend.title = element_blank()) +
  theme(legend.text=element_text(size=9)) +
  ggsave(here::here("NRV Analysis", "canopy_cover", "Figures", "Publics_wo_oaks.png"),
         height=5,
         width=7,
         units="in")
```



